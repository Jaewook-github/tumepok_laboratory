# 주문체결 (00)

## TR 정보
- **TR 코드**: 00
- **TR 명**: 주문체결
- **타입**: WebSocket 실시간 데이터
- **용도**: 주문체결 실시간 통신

## WebSocket 연결 및 실시간 데이터 수신

```python
import asyncio 
import websockets
import json

# socket 정보
# SOCKET_URL = 'wss://mockapi.kiwoom.com:10000/api/dostk/websocket'  # 모의투자 접속 URL
SOCKET_URL = 'wss://api.kiwoom.com:10000/api/dostk/websocket'  # 접속 URL
ACCESS_TOKEN = '사용자 AccessToken'  # 고객 Access Token

class WebSocketClient:
	def __init__(self, uri):
		self.uri = uri
		self.websocket = None
		self.connected = False
		self.keep_running = True

	# WebSocket 서버에 연결합니다.
	async def connect(self):
		try:
			self.websocket = await websockets.connect(self.uri)
			self.connected = True
			print("서버와 연결을 시도 중입니다.")

			# 로그인 패킷
			param = {
				'trnm': 'LOGIN',
				'token': ACCESS_TOKEN
			}

			print('실시간 시세 서버로 로그인 패킷을 전송합니다.')
			# 웹소켓 연결 시 로그인 정보 전달
			await self.send_message(message=param)

		except Exception as e:
			print(f'Connection error: {e}')
			self.connected = False

	# 서버에 메시지를 보냅니다. 연결이 없다면 자동으로 연결합니다.
	async def send_message(self, message):
		if not self.connected:
			await self.connect()  # 연결이 끊어졌다면 재연결
		if self.connected:
			# message가 문자열이 아니면 JSON으로 직렬화
			if not isinstance(message, str):
				message = json.dumps(message)

		await self.websocket.send(message)
		print(f'Message sent: {message}')

	# 서버에서 오는 메시지를 수신하여 출력합니다.
	async def receive_messages(self):
		while self.keep_running:
			try:
				# 서버로부터 수신한 메시지를 JSON 형식으로 파싱
				response = json.loads(await self.websocket.recv())

				# 메시지 유형이 LOGIN일 경우 로그인 시도 결과 체크
				if response.get('trnm') == 'LOGIN':
					if response.get('return_code') != 0:
						print('로그인 실패하였습니다. : ', response.get('return_msg'))
						await self.disconnect()
					else:
						print('로그인 성공하였습니다.')

				# 메시지 유형이 PING일 경우 수신값 그대로 송신
				elif response.get('trnm') == 'PING':
					await self.send_message(response)

				if response.get('trnm') != 'PING':
					print(f'실시간 시세 서버 응답 수신: {response}')

			except websockets.ConnectionClosed:
				print('Connection closed by the server')
				self.connected = False
				await self.websocket.close()

	# WebSocket 실행
	async def run(self):
		await self.connect()
		await self.receive_messages()

	# WebSocket 연결 종료
	async def disconnect(self):
		self.keep_running = False
		if self.connected and self.websocket:
			await self.websocket.close()
			self.connected = False
			print('Disconnected from WebSocket server')

async def main():
	# WebSocketClient 전역 변수 선언
	websocket_client = WebSocketClient(SOCKET_URL)

	# WebSocket 클라이언트를 백그라운드에서 실행합니다.
	receive_task = asyncio.create_task(websocket_client.run())

	# 실시간 항목 등록
	await asyncio.sleep(1)
	await websocket_client.send_message({ 
		'trnm': 'REG', # 서비스명
		'grp_no': '1', # 그룹번호
		'refresh': '1', # 기존등록유지여부
		'data': [{ # 실시간 등록 리스트
			'item': [''], # 실시간 등록 요소
			'type': ['00'], # 실시간 항목
		}]
	})

	# 수신 작업이 종료될 때까지 대기
	await receive_task

# asyncio로 프로그램을 실행합니다.
if __name__ == '__main__':
	asyncio.run(main())
```

## 요청 (Request)

| Element | 한글명 | Type | Required | Length | Description |
|---------|--------|------|----------|---------|-------------|
| trnm | 서비스명 | String | Y | 10 | REG : 등록 , REMOVE : 해지 |
| grp_no | 그룹번호 | String | Y | 4 |  |
| refresh | 기존등록유지여부 | String | Y | 1 | 등록(REG)시<br>0:기존유지안함 1:기존유지(Default)<br>0일경우 기존등록한 item/type은 해지, 1일경우 기존등록한 item/type 유지<br>해지(REMOVE)시 값 불필요 |
| data | 실시간 등록 리스트 | LIST |  |  |  |
| - item | 실시간 등록 요소 | String[] | N | 100 |  |
| - type | 실시간 항목 | String[] | Y | 2 | TR 명(0A,0B....) |

## 응답 (Response)

| Element | 한글명 | Type | Required | Length | Description |
|---------|--------|------|----------|---------|-------------|
| return_code | 결과코드 | int | N |  | 통신결과에대한 코드<br>(등록,해지요청시에만 값 전송 0:정상,1:오류 , 데이터 실시간 수신시 미전송) |
| return_msg | 결과메시지 | String | N |  | 통신결과에대한메시지 |
| trnm | 서비스명 | String | N |  | 등록,해지요청시 요청값 반환 , 실시간수신시 REAL 반환 |
| data | 실시간 등록리스트 | LIST | N |  |  |
| - type | 실시간항목 | String | N |  | TR 명(0A,0B....) |
| - name | 실시간 항목명 | String | N |  |  |
| - item | 실시간 등록 요소 | String | N |  | 종목코드 |
| - values | 실시간 값 리스트 | LIST | N |  |  |

### Values 필드 목록

| Field | 한글명 | Type | Description |
|--------|--------|------|-------------|
| 9201 | 계좌번호 | String |  |
| 9203 | 주문번호 | String |  |
| 9205 | 관리자사번 | String |  |
| 9001 | 종목코드,업종코드 | String |  |
| 912 | 주문업무분류 | String |  |
| 913 | 주문상태 | String |  |
| 302 | 종목명 | String |  |
| 900 | 주문수량 | String |  |
| 901 | 주문가격 | String |  |
| 902 | 미체결수량 | String |  |
| 903 | 체결누계금액 | String |  |
| 904 | 원주문번호 | String |  |
| 905 | 주문구분 | String |  |
| 906 | 매매구분 | String |  |
| 907 | 매도수구분 | String |  |
| 908 | 주문/체결시간 | String |  |
| 909 | 체결번호 | String |  |
| 910 | 체결가 | String |  |
| 911 | 체결량 | String |  |
| 10 | 현재가 | String |  |
| 27 | (최우선)매도호가 | String |  |
| 28 | (최우선)매수호가 | String |  |
| 914 | 단위체결가 | String |  |
| 915 | 단위체결량 | String |  |
| 938 | 당일매매수수료 | String |  |
| 939 | 당일매매세금 | String |  |
| 919 | 거부사유 | String |  |
| 920 | 화면번호 | String |  |
| 921 | 터미널번호 | String |  |
| 922 | 신용구분 | String | 실시간 체결용 |
| 923 | 대출일 | String | 실시간 체결용 |
| 10010 | 시간외단일가_현재가 | String |  |
| 2134 | 거래소구분 | String | 0:통합,1:KRX,2:NXT |
| 2135 | 거래소구분명 | String | 통합,KRX,NXT |
| 2136 | SOR여부 | String | Y,N |